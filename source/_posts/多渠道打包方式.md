---
title: 多渠道打包方式
date: 2016-09-10 10:20:49
tags: 打包方式
category: Android
---
首先我说明一下什么是多渠道打包？

国内存在着众多的Android应用市场，为了统计不同安卓应用市场的下载量一个个性化统计需求，需要为每个应用市场的Android包设定一个可以区分应用市场的标识，这个为Android包设定应用市场标识的过程就是多渠道打包。

废话介绍...忽略吧... 主要看内容

<!-- more -->

主要是想说一下，现在比较流行的几种多渠道打包方式，如果我没写到的，而且有新的打包方式 留言给我哈。。

 
## 通过配置gradle脚本实现多渠道打包

使用Android Studio的编译工具gradle配合使用的，其核心原理就是通过脚本修改AndroidManifest.xml中的mate-date内容，执行N次打包签名操作。

以[SkyApp](https://github.com/skyJinc/SkyApp)项目为例子

### 在Androidmanifest.xml中定义mate-data标签

    <application
        android:name=".SkyTestApplication"
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:supportsRtl="true"
        android:theme="@style/AppTheme">
        <activity
            android:name=".view.LoginActivity"
            android:label="@string/app_name">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>

                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>

        <activity android:name=".view.ListActivity"/>

        <!-- 多渠道打包-->
        <meta-data
            android:name="UMENG_CHANNEL"
            android:value="{UMENG}"/>

    </application>
    
### 在build.gradle下的productFlavors定义渠道号：

![tu](https://skyJinc.github.io/images/android多渠道打包/1.png)

 - 执行 gradle assembleRelease 后 产生包

![tu](https://skyJinc.github.io/images/android多渠道打包/2.png)

 - 优势：方便灵活，可以根据自身的需求配置不同的渠道执行不同的逻辑； 

 - 劣势：渠道多了，打包太慢了.....

 
## 使用第三方打包工具

这种方式就是使用第三方的服务，比如360，百度，友盟等，其原理也是通过修改AndroidManifest.xml中的mate-data标签内容，然后执行N次打包签名的操作实现多渠道打包的。这里就不在做具体解释说明

 - 优势：简单方便，几乎不用自身做什么工作； 

 - 劣势：渠道多了，打包还是太慢了.....

 
## python脚本实现 打包

 - python是一款应用非常广泛的脚本程序语言，谷歌公司的网页就是用python编写。python在生物信息、统计、网页制作、计算等多个领域都体现出了强大的功能。python和其他脚本语言如java、R、Perl 一样，都可以直接在命令行里运行脚本程序。

 - 看了说明, 无非就是写一个脚本把APK包解压,写入文件,在压缩,这样每一个APK包内都会有一个渠道文件,在Apk启动时读取该文件。

 - 写python脚本 我喜欢使用 [Sublime Text 2](http://www.sublimetext.com/2)
	
 - 我使用 pyhon版本 Python 2.7.10

### 创建文件

 - 位置无所谓了，不过我喜欢创建在项目的根目录

 - 创建渠道列表文件 channellist.txt //名字自己起
 
![tu](https://skyJinc.github.io/images/android多渠道打包/4.png)


### 通过ST2写Python脚本

 - 创建Python文件 和 空文件(主要用于写入文件）

![tu](https://skyJinc.github.io/images/android多渠道打包/5.png)

#### sky.py

	#!/usr/bin/python
	# coding=utf-8
	import sys
	import zipfile
	import shutil
	import os
	# 定义 日志类
	class Log(object):
	    RED     = '\033[31m'
	    GREEN   = '\033[32m'
	    YELLOW  = '\033[33m'
	    MAGENTA = '\033[35m'
	    RESET   = '\033[0m'
	    
	    @staticmethod
	    def skyPrint(s, color = None):
	        if color and sys.stdout.isatty() and sys.platform != 'win32':
	            print(color + s + Log.RESET)
	        else:
	            print(s)
	    
	    @staticmethod     
	    def d(s):
	        Log.skyPrint(s, Log.MAGENTA)
	        
	     
	    @staticmethod   
	    def i(s):
	        Log.skyPrint(s, Log.GREEN)
	        
	    @staticmethod
	    def w(s):
	        Log.skyPrint(s, Log.YELLOW)
	        
	    @staticmethod
	    def e(s):
	        Log.skyPrint(s, Log.RED)
	
	# 空文件 便于写入此空文件到apk包中作为channel文件
	src_empty_file = './channel/skychannelname.txt'
	# 创建一个空文件（不存在则创建）
	f = open(src_empty_file, 'w') 
	f.close()
	
	apkpath = './app/build/outputs/apk/'
	# 获取指定目录中所有的apk源包
	src_apks = []
	def gci(filepath):
	#遍历filepath下所有文件，包括子目录
	  files = os.listdir(filepath)
	  for file in files:
	    fi_d = os.path.join(filepath,file)            
	    if os.path.isfile(fi_d):
	       filename = os.path.basename(file)
	       if 'unaligned.apk' in filename:
	          Log.d("exclude unaligned.apk:%s\n" %filename)  
	       else:  
	          extension = os.path.splitext(file)[1][1:] 
	          if extension in 'apk':
	             src_apks.append(fi_d)
			  
	
	#获取apkpath下的apk文件
	gci(apkpath)
	
	Log.d("source apks:%s\n" %src_apks)
	
	# 获取渠道列表
	channel_file = './channel/channellist.txt'
	f = open(channel_file)
	lines = f.readlines()
	f.close()
	
	Log.d("channel list:%s\n" %lines)
	
	for src_apk in src_apks:
	    # file name (with extension)
	    src_apk_file_name = os.path.basename(src_apk)
	    # 分割文件名与后缀
	    temp_list = os.path.splitext(src_apk_file_name)
	    # name without extension
	    src_apk_name = temp_list[0]
	    # 后缀名，包含.   例如: ".apk "
	    src_apk_extension = temp_list[1]
	    
	    # 创建生成目录,与文件名相关
	    output_dir = apkpath + 'channel_' + src_apk_name + '/'
	
	    Log.d("output_dir:%s\n" %output_dir)
	
	    # 目录不存在则创建
	    if not os.path.exists(output_dir):
	        os.mkdir(output_dir)
	
	    # 遍历渠道号并创建对应渠道号的apk文件
	    for line in lines:
	        # 获取当前渠道号，因为从渠道文件中获得带有\n,所有strip一下
	        target_channel = line.strip()
	        # 拼接对应渠道号的apk
	        target_apk = output_dir + src_apk_name + "-" + target_channel + src_apk_extension
	
	        Log.d("target channel apk:%s\n" %target_apk)
	
	        # 拷贝建立新apk
	        shutil.copy(src_apk,  target_apk)
	        # zip获取新建立的apk文件
	        zipped = zipfile.ZipFile(target_apk, 'a', zipfile.ZIP_DEFLATED)
	        # 初始化渠道信息
	        empty_channel_file = "META-INF/skychannelname-{channel}".format(channel = target_channel)
	        # 写入渠道信息
	        zipped.write(src_empty_file, empty_channel_file)
	        # 关闭zip流
	        zipped.close()

 - 看代码费劲的话,用ST2看...

 ![tu](https://skyJinc.github.io/images/android多渠道打包/3.png)

 - 不了解Python的人自行百度学习..
 - 为了不会Python的人，大概说一下注意的地方
![tu](https://skyJinc.github.io/images/android多渠道打包/7.png)
![tu](https://skyJinc.github.io/images/android多渠道打包/8.png)
![tu](https://skyJinc.github.io/images/android多渠道打包/9.png)

### 执行脚本
	
	//使用gradle打包  
	gradle clean assembleRelease
	
	//使用python执行 python脚本 - 因为我的sky.py在SkyApp根目录 使用 AS里Terminal执行
	python channel/sky.py 


![tu](https://skyJinc.github.io/images/android多渠道打包/18.png)

是不是很简单？ 这样就生成完了所有渠道包

![tu](https://skyJinc.github.io/images/android多渠道打包/17.png)

### 验证

安装自己看网站吧

[Apktool](https://ibotpeaches.github.io/Apktool/install/) 大家因该很熟悉，反编译使用

	mac os
	
	sudo mv file /usr/local/bin

	sudo chmod a+x file
	
	apktool d xxx.apk

很简单...我们找一个 上面生成的渠道apk 进行反编译

![tu](https://skyJinc.github.io/images/android多渠道打包/19.png)

我们反编译了 sky_fir.apk 这个渠道包

![tu](https://skyJinc.github.io/images/android多渠道打包/20.png)

可以看到我们写入的渠道文件已经生成了。。

### 写代码
前面准备工作做完了,开始写代码获取渠道信息吧

我把渠道当成一个管理渠道的工具，所以结合Sky架构 定义manage方式 来编写

#### 创建
![tu](https://skyJinc.github.io/images/android多渠道打包/10.png)

		package sky.skyapp.helper.modules;
		
		import android.content.Context;
		import android.content.pm.ApplicationInfo;
		import android.text.TextUtils;
		
		import org.apache.commons.lang3.StringUtils;
		
		import java.io.IOException;
		import java.util.Enumeration;
		import java.util.zip.ZipEntry;
		import java.util.zip.ZipFile;
		
		/**
		 * @创建人 sky
		 * @创建时间 16/9/10 下午12:03
		 * @类描述
		 */
		public class ChannelManage {
		
			// 渠道KEY
			private static final String	CHANNEL_KEY		= "skychannelname";
		
			// 默认渠道
			private static final String	DEFAULT_CHANNEL	= "sky";
		
			private String				mChannel;
		
			public ChannelManage(Context context) {
				mChannel = getChannelFromApk(context, CHANNEL_KEY);
				if (StringUtils.isEmpty(mChannel)) {
					mChannel = DEFAULT_CHANNEL;
				}
			}
		
			/**
			 * 获取渠道
			 * 
			 * @return
			 */
			public String getChannel() {
				return mChannel;
			}
		
			/**
			 * 从apk中获取版本信息
			 *
			 * @param context
			 * @param channelKey
			 * @return
			 */
			private static String getChannelFromApk(Context context, String channelKey) {
				long startTime = System.currentTimeMillis();
				// 从apk包中获取
				ApplicationInfo appinfo = context.getApplicationInfo();
				String sourceDir = appinfo.sourceDir;
				// 默认放在meta-inf/里， 所以需要再拼接一下
				String key = "META-INF/" + channelKey;
				String ret = "";
				ZipFile zipfile = null;
				try {
					zipfile = new ZipFile(sourceDir);
					Enumeration<?> entries = zipfile.entries();
					while (entries.hasMoreElements()) {
						ZipEntry entry = ((ZipEntry) entries.nextElement());
						String entryName = entry.getName();
						if (entryName.startsWith(key)) {
							ret = entryName;
							break;
						}
					}
				} catch (IOException e) {
					e.printStackTrace();
				} finally {
					if (zipfile != null) {
						try {
							zipfile.close();
						} catch (IOException e) {
							e.printStackTrace();
						}
					}
				}
				String channel = "";
				if (StringUtils.isNotBlank(ret)) {
					String[] split = ret.split("_");
					channel = split[1];
					System.out.println("-----------------------------");
					System.out.println("渠道号：" + channel + "，解压获取渠道号耗时:" + (System.currentTimeMillis() - startTime) + "ms");
					System.out.println("-----------------------------");
				} else {
					System.out.println("未解析到相应的渠道号，使用默认内部渠道号");
					channel = DEFAULT_CHANNEL;
				}
				return channel;
		}
		}

 - 说明:

1. ***skychannelname*** 就是写入的文件key,一定要一致
2. 下面图这一部分，根据自己定的规则来写吧。SkyApp 规则很简单
![tu](https://skyJinc.github.io/images/android多渠道打包/11.png)

#### sky架构定义manage:
![tu](https://skyJinc.github.io/images/android多渠道打包/12.png)
![tu](https://skyJinc.github.io/images/android多渠道打包/13.png)
 
 - 这样MyProHelper里就有了渠道管理功能

#### 使用

 - 界面

![tu](https://skyJinc.github.io/images/android多渠道打包/14.png)

 - 点击事件

![tu](https://skyJinc.github.io/images/android多渠道打包/15.png)


## Jenkins 进行多渠道打包

前面有一篇文章***可持续集成架构***的文章已经说了怎么搭建

[连接](http://www.jincanshen.com/2016/08/22/%E5%8F%AF%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/)

 - 配置Jenkins 执行python脚本 实现多渠道打包

看过前面文章的大家应该很清楚了。。

![tu](https://skyJinc.github.io/images/android多渠道打包/21.png)
![tu](https://skyJinc.github.io/images/android多渠道打包/22.png)
![tu](https://skyJinc.github.io/images/android多渠道打包/23.png)

 - linux

![tu](https://skyJinc.github.io/images/android多渠道打包/24.png)

 - mac

![tu](https://skyJinc.github.io/images/android多渠道打包/25.png) 

![tu](https://skyJinc.github.io/images/android多渠道打包/26.png) 

![tu](https://skyJinc.github.io/images/android多渠道打包/27.png) 

 - 多了一个	app-release-unaligned.apk 包 很烦人通过gradle 删除

![tu](https://skyJinc.github.io/images/android多渠道打包/28.png) 

 - 或者使用命令删除

![tu](https://skyJinc.github.io/images/android多渠道打包/29.png)

## Jenkins 参数化构建

### SVN配置
 - 设置参数
![tu](https://skyJinc.github.io/images/android多渠道打包/30.png)
 - gradle 配置参数 -  命令 **-P** 表示定义参数
![tu](https://skyJinc.github.io/images/android多渠道打包/32.png)
 - SVN 配置
![tu](https://skyJinc.github.io/images/android多渠道打包/31.png)

 - 执行
![tu](https://skyJinc.github.io/images/android多渠道打包/33.png)

 - 说明： 根据版本不同可以打包不同的包，或者之前版本的包

### GIT配置

 - 设置参数

![tu](https://skyJinc.github.io/images/android多渠道打包/34.png)

 - gradle 配置参数 -  命令 **-P** 表示定义参数

![tu](https://skyJinc.github.io/images/android多渠道打包/37.png)

 - GIT 配置

![tu](https://skyJinc.github.io/images/android多渠道打包/35.png)

 - GIT 配置命令说明

![tu](https://skyJinc.github.io/images/android多渠道打包/36.png)

 - 执行

![tu](https://skyJinc.github.io/images/android多渠道打包/38.png)

### 项目配置

![tu](https://skyJinc.github.io/images/android多渠道打包/39.png)


### 结果

 * 因为我只有Git环境, 结果是Git配置后的～ SVN 没搭，不过在公司有SVN配置后可以使用。。。

 * SkyApp项目之前Tag版本没有设置Gradle配置所以无法使用


![tu](https://skyJinc.github.io/images/android多渠道打包/40.png)


## 结尾

希望转发或者分享的时候 备注一下 来源.... 原创很费劲的。。。

